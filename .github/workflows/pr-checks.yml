name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # PR æ ‡é¢˜æ£€æŸ¥
  pr-title-check:
    name: PR Title Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # å…è®¸çš„ç±»å‹
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          # å…è®¸çš„èŒƒå›´ï¼ˆå¯é€‰ï¼‰
          scopes: |
            backend
            frontend
            e2e
            deps
            ci
          requireScope: false
          # å…è®¸å¤šè¡Œä¸»é¢˜
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            ä¸»é¢˜ä¸åº”ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚
            æ­£ç¡®æ ¼å¼: "feat: add new feature" æˆ– "fix(backend): resolve bug"

  # PR å¤§å°æ£€æŸ¥
  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let label = '';
            let message = '';

            if (total < 100) {
              label = 'size/XS';
              message = 'âœ… éå¸¸å°çš„ PRï¼Œæ˜“äºå®¡æŸ¥';
            } else if (total < 300) {
              label = 'size/S';
              message = 'âœ… å°å‹ PRï¼Œæ˜“äºå®¡æŸ¥';
            } else if (total < 600) {
              label = 'size/M';
              message = 'âš ï¸ ä¸­ç­‰å¤§å°çš„ PR';
            } else if (total < 1000) {
              label = 'size/L';
              message = 'âš ï¸ è¾ƒå¤§çš„ PRï¼Œå»ºè®®æ‹†åˆ†';
            } else {
              label = 'size/XL';
              message = 'âŒ éå¸¸å¤§çš„ PRï¼Œå¼ºçƒˆå»ºè®®æ‹†åˆ†æˆå¤šä¸ªå° PR';
            }

            // æ·»åŠ æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [label]
            });

            // æ·»åŠ è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `ğŸ“Š **PR å¤§å°**: ${total} è¡Œå˜æ›´ (+${additions}, -${deletions})\n\n${message}`
            });

            console.log(`PR å¤§å°: ${total} è¡Œï¼Œæ ‡ç­¾: ${label}`);

  # æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶å†²çª
  conflict-check:
    name: Check Merge Conflicts
    runs-on: ubuntu-latest
    steps:
      - name: Check for merge conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr.mergeable === false) {
              core.setFailed('âŒ PR å­˜åœ¨åˆå¹¶å†²çªï¼Œè¯·å…ˆè§£å†³å†²çª');
            } else if (pr.mergeable === true) {
              console.log('âœ… æ— åˆå¹¶å†²çª');
            } else {
              console.log('â³ æ­£åœ¨æ£€æŸ¥åˆå¹¶çŠ¶æ€...');
            }

  # è‡ªåŠ¨æ ‡ç­¾
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  # PR æè¿°æ£€æŸ¥
  pr-description-check:
    name: PR Description Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // æ£€æŸ¥æè¿°é•¿åº¦
            if (body.length < 30) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: 'âš ï¸ PR æè¿°è¿‡çŸ­ï¼Œè¯·æ·»åŠ æ›´è¯¦ç»†çš„è¯´æ˜ï¼ŒåŒ…æ‹¬ï¼š\n\n- ğŸ¯ æ”¹åŠ¨ç›®çš„\n- ğŸ“ ä¸»è¦å˜æ›´\n- âœ… æµ‹è¯•è®¡åˆ’\n- ğŸ“¸ æˆªå›¾ï¼ˆå¦‚é€‚ç”¨ï¼‰'
              });
              core.setFailed('PR æè¿°è¿‡çŸ­');
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å« checklist
            const hasChecklist = body.includes('- [') || body.includes('- [ ]');
            if (!hasChecklist) {
              console.log('âš ï¸ PR æè¿°ä¸­æœªåŒ…å« checklist');
            }
